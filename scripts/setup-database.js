#!/usr/bin/env node

const { createClient } = require('@supabase/supabase-js');

// Configuration Supabase
const supabaseUrl = 'https://cmmfaatcdtbmcmjnegyn.supabase.co';
const supabaseAnonKey = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtbWZhYXRjZHRibWNtam5lZ3luIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU4MTA5MzIsImV4cCI6MjA1MTM4NjkzMn0.jZHRiDxdj0wpuZXluZwicm9ZSIGmFub241CJpXQJQJE3NTE0NTUzN09eCSOKl7qIrtH8tmzXZwU3khb7M';

const supabase = createClient(supabaseUrl, supabaseAnonKey);

async function setupDatabase() {
  console.log('üöÄ Configuration de la base de donn√©es Caddy...\n');

  try {
    // 1. Cr√©er les tables
    console.log('üìã Cr√©ation des tables...');
    
    // Utilisation de .sql() au lieu de .rpc()
    const tables = [
      // Table des v√©hicules
      `CREATE TABLE IF NOT EXISTS vehicles (
        id SERIAL PRIMARY KEY,
        nom VARCHAR(50) NOT NULL,
        capacite INTEGER NOT NULL,
        type VARCHAR(50) NOT NULL,
        couleur VARCHAR(20),
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
      );`,
      
      // Table des employ√©s
      `CREATE TABLE IF NOT EXISTS employees (
        id SERIAL PRIMARY KEY,
        nom VARCHAR(100) NOT NULL,
        prenom VARCHAR(100),
        email VARCHAR(255) UNIQUE,
        telephone VARCHAR(20),
        profil VARCHAR(20) NOT NULL CHECK (profil IN ('Faible', 'Moyen', 'Fort')),
        langues TEXT[] DEFAULT '{}',
        permis BOOLEAN DEFAULT FALSE,
        etoiles INTEGER DEFAULT 1 CHECK (etoiles IN (1, 2)),
        statut VARCHAR(20) DEFAULT 'Actif' CHECK (statut IN ('Actif', 'Absent', 'Formation')),
        date_embauche DATE,
        notes TEXT,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
      );`,
      
      // Table des comp√©tences
      `CREATE TABLE IF NOT EXISTS competences (
        id SERIAL PRIMARY KEY,
        employee_id INTEGER REFERENCES employees(id) ON DELETE CASCADE,
        vehicle_id INTEGER REFERENCES vehicles(id) ON DELETE CASCADE,
        niveau VARCHAR(20) NOT NULL CHECK (niveau IN ('X', 'XX')),
        date_validation DATE,
        notes TEXT,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        UNIQUE(employee_id, vehicle_id)
      );`,
      
      // Table du planning
      `CREATE TABLE IF NOT EXISTS planning (
        id SERIAL PRIMARY KEY,
        employee_id INTEGER REFERENCES employees(id) ON DELETE CASCADE,
        vehicle_id INTEGER REFERENCES vehicles(id) ON DELETE CASCADE,
        date DATE NOT NULL,
        role VARCHAR(50) DEFAULT '√âquipier',
        notes TEXT,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
      );`,
      
      // Fonction pour updated_at
      `CREATE OR REPLACE FUNCTION update_updated_at_column()
       RETURNS TRIGGER AS $$
       BEGIN
           NEW.updated_at = NOW();
           RETURN NEW;
       END;
       $$ language 'plpgsql';`,
       
      // Triggers
      `CREATE TRIGGER IF NOT EXISTS update_vehicles_updated_at BEFORE UPDATE ON vehicles FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();`,
      `CREATE TRIGGER IF NOT EXISTS update_employees_updated_at BEFORE UPDATE ON employees FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();`,
      `CREATE TRIGGER IF NOT EXISTS update_competences_updated_at BEFORE UPDATE ON competences FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();`,
      `CREATE TRIGGER IF NOT EXISTS update_planning_updated_at BEFORE UPDATE ON planning FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();`
    ];

    for (const sql of tables) {
      try {
        await supabase.from('_').select().limit(0); // Test de connexion
        console.log('‚ö†Ô∏è Les tables doivent √™tre cr√©√©es manuellement via SQL Editor');
        console.log('üìã Copiez le contenu de database/schema.sql dans Supabase SQL Editor');
        break;
      } catch (error) {
        // Continue avec l'insertion des donn√©es
        break;
      }
    }

    // 2. Ins√©rer les v√©hicules
    console.log('üöó Insertion des v√©hicules...');
    const vehicles = [
      { nom: 'Crafter 21', capacite: 3, type: 'Collecte', couleur: '#3b82f6' },
      { nom: 'Crafter 23', capacite: 3, type: 'Collecte', couleur: '#10b981' },
      { nom: 'Jumper', capacite: 3, type: 'Collecte', couleur: '#8b5cf6' },
      { nom: 'Ducato', capacite: 3, type: 'Collecte', couleur: '#f59e0b' },
      { nom: 'Transit', capacite: 8, type: 'Formation', couleur: '#ef4444' }
    ];

    const { error: vehiclesError } = await supabase
      .from('vehicles')
      .upsert(vehicles, { onConflict: 'nom' });
    
    if (vehiclesError) {
      console.log('‚ö†Ô∏è Table vehicles non trouv√©e. Cr√©ez d\'abord les tables avec schema.sql');
      console.log('‚úÖ Script pr√©par√©, ex√©cutez d\'abord les tables manuellement');
      return;
    }
    console.log('‚úÖ V√©hicules ins√©r√©s');

    // 3. Ins√©rer les employ√©s
    console.log('üë• Insertion des employ√©s...');
    const employees = [
      { nom: 'Martial', prenom: 'Martial', profil: 'Fort', langues: ['Fran√ßais'], permis: true, etoiles: 2, email: 'martial@caddy.lu' },
      { nom: 'Margot', prenom: 'Margot', profil: 'Moyen', langues: ['Fran√ßais'], permis: true, etoiles: 2, email: 'margot@caddy.lu' },
      { nom: 'Shadi', prenom: 'Shadi', profil: 'Fort', langues: ['Arabe', 'Anglais', 'Fran√ßais'], permis: false, etoiles: 2, email: 'shadi@caddy.lu' },
      { nom: 'Ahmad', prenom: 'Ahmad', profil: 'Moyen', langues: ['Arabe'], permis: true, etoiles: 1, email: 'ahmad@caddy.lu' },
      { nom: 'Tamara', prenom: 'Tamara', profil: 'Faible', langues: ['Luxembourgeois', 'Fran√ßais'], permis: true, etoiles: 1, email: 'tamara@caddy.lu' },
      { nom: 'Soroosh', prenom: 'Soroosh', profil: 'Fort', langues: ['Perse'], permis: true, etoiles: 2, email: 'soroosh@caddy.lu' },
      { nom: 'Imad', prenom: 'Imad', profil: 'Moyen', langues: ['Arabe'], permis: true, etoiles: 1, email: 'imad@caddy.lu' },
      { nom: 'Basel', prenom: 'Basel', profil: 'Faible', langues: ['Arabe'], permis: false, etoiles: 1, email: 'basel@caddy.lu' },
      { nom: 'Firas', prenom: 'Firas', profil: 'Moyen', langues: ['Arabe'], permis: true, etoiles: 1, email: 'firas@caddy.lu' },
      { nom: 'Jos√©', prenom: 'Jos√©', profil: 'Fort', langues: ['Espagnol', 'Fran√ßais'], permis: true, etoiles: 2, email: 'jose@caddy.lu' },
      { nom: 'Juan', prenom: 'Juan', profil: 'Moyen', langues: ['Espagnol'], permis: false, etoiles: 1, email: 'juan@caddy.lu' },
      { nom: 'Emaha', prenom: 'Emaha', profil: 'Faible', langues: ['Tigrinya'], permis: false, etoiles: 1, email: 'emaha@caddy.lu' },
      { nom: 'Medha', prenom: 'Medha', profil: 'Faible', langues: ['Tigrinya'], permis: false, etoiles: 1, email: 'medha@caddy.lu' },
      { nom: 'Tesfa', prenom: 'Tesfa', profil: 'Moyen', langues: ['Tigrinya'], permis: false, etoiles: 1, email: 'tesfa@caddy.lu' },
      // Votre compte admin
      { 
        nom: 'Deazevedo', 
        prenom: 'Maxime', 
        profil: 'Fort', 
        langues: ['Fran√ßais', 'Anglais'], 
        permis: true, 
        etoiles: 2, 
        email: 'maxime@caddy.lu',
        date_embauche: new Date().toISOString().split('T')[0],
        notes: 'Administrateur syst√®me - Acc√®s complet'
      }
    ];

    const { error: employeesError } = await supabase
      .from('employees')
      .upsert(employees, { onConflict: 'email' });
    if (employeesError) throw employeesError;
    console.log('‚úÖ Employ√©s ins√©r√©s');

    // 4. Configurer les comp√©tences
    console.log('üéØ Configuration des comp√©tences...');
    
    // R√©cup√©rer les IDs des employ√©s et v√©hicules
    const { data: empData } = await supabase.from('employees').select('id, nom');
    const { data: vehData } = await supabase.from('vehicles').select('id, nom');
    
    const empMap = empData.reduce((acc, emp) => ({ ...acc, [emp.nom]: emp.id }), {});
    const vehMap = vehData.reduce((acc, veh) => ({ ...acc, [veh.nom]: veh.id }), {});

    const competences = [];
    
    // Comp√©tences selon vos tableaux Excel
    const competenceConfig = {
      'Crafter 21': {
        'XX': ['Martial', 'Margot', 'Shadi', 'Soroosh', 'Jos√©', 'Deazevedo'],
        'X': ['Ahmad', 'Imad', 'Firas']
      },
      'Crafter 23': {
        'XX': ['Martial', 'Margot', 'Ahmad', 'Soroosh', 'Jos√©', 'Deazevedo'],
        'X': ['Shadi', 'Imad', 'Firas', 'Juan']
      },
      'Jumper': {
        'XX': ['Martial', 'Margot', 'Ahmad', 'Soroosh', 'Imad', 'Jos√©', 'Deazevedo'],
        'X': ['Shadi', 'Firas', 'Juan']
      },
      'Ducato': {
        'XX': ['Martial', 'Margot', 'Ahmad', 'Soroosh', 'Imad', 'Jos√©', 'Firas', 'Deazevedo'],
        'X': ['Shadi', 'Juan']
      },
      'Transit': {
        'XX': ['Martial', 'Margot', 'Ahmad', 'Soroosh', 'Imad', 'Jos√©', 'Firas', 'Juan', 'Deazevedo'],
        'X': ['Shadi', 'Tamara', 'Basel', 'Tesfa']
      }
    };

    Object.entries(competenceConfig).forEach(([vehicleName, levels]) => {
      const vehicleId = vehMap[vehicleName];
      if (vehicleId) {
        Object.entries(levels).forEach(([niveau, employes]) => {
          employes.forEach(nom => {
            const employeeId = empMap[nom];
            if (employeeId) {
              competences.push({
                employee_id: employeeId,
                vehicle_id: vehicleId,
                niveau,
                date_validation: new Date().toISOString().split('T')[0]
              });
            }
          });
        });
      }
    });

    const { error: compError } = await supabase
      .from('competences')
      .upsert(competences, { onConflict: ['employee_id', 'vehicle_id'] });
    if (compError) throw compError;
    console.log('‚úÖ Comp√©tences configur√©es');

    // 5. Cr√©er un planning de d√©monstration
    console.log('üìÖ Cr√©ation du planning de d√©monstration...');
    const planning = [
      { employee_id: empMap['Martial'], vehicle_id: vehMap['Crafter 21'], date: new Date().toISOString().split('T')[0], role: 'Conducteur' },
      { employee_id: empMap['Shadi'], vehicle_id: vehMap['Crafter 21'], date: new Date().toISOString().split('T')[0], role: '√âquipier' },
      { employee_id: empMap['Tamara'], vehicle_id: vehMap['Crafter 21'], date: new Date().toISOString().split('T')[0], role: '√âquipier' },
      { employee_id: empMap['Margot'], vehicle_id: vehMap['Crafter 23'], date: new Date().toISOString().split('T')[0], role: 'Conducteur' },
      { employee_id: empMap['Ahmad'], vehicle_id: vehMap['Crafter 23'], date: new Date().toISOString().split('T')[0], role: '√âquipier' },
      { employee_id: empMap['Basel'], vehicle_id: vehMap['Crafter 23'], date: new Date().toISOString().split('T')[0], role: '√âquipier' }
    ].filter(p => p.employee_id && p.vehicle_id);

    const { error: planError } = await supabase
      .from('planning')
      .upsert(planning, { onConflict: ['employee_id', 'vehicle_id', 'date'] });
    if (planError) throw planError;
    console.log('‚úÖ Planning de d√©monstration cr√©√©');

    console.log('\nüéâ Configuration des donn√©es termin√©e avec succ√®s !');
    console.log('\nüìã R√©sum√© :');
    console.log('‚Ä¢ V√©hicules : 5 v√©hicules de la flotte');
    console.log('‚Ä¢ Employ√©s : 14 employ√©s + votre compte admin');
    console.log('‚Ä¢ Comp√©tences : Configur√©es selon vos tableaux Excel');
    console.log('‚Ä¢ Planning : D√©monstration pour aujourd\'hui');
    
    console.log('\n‚ö†Ô∏è √âTAPES RESTANTES :');
    console.log('1. Allez sur https://supabase.com/dashboard/project/cmmfaatcdtbmcmjnegyn');
    console.log('2. Authentication > Users > Add User :');
    console.log('   Email: maxime@caddy.lu');
    console.log('   Password: Cristobello54');
    console.log('   Email Confirm: ‚úì');
    console.log('3. Si les tables n\'existent pas, SQL Editor > Ex√©cutez database/schema.sql');
    console.log('\nüöÄ Puis testez l\'application !');

  } catch (error) {
    console.error('‚ùå Erreur lors de la configuration :', error);
    console.log('\nüîß Solution :');
    console.log('1. V√©rifiez que les tables existent (schema.sql)');
    console.log('2. Cr√©ez votre compte manuellement sur Supabase Dashboard');
    console.log('3. Relancez ce script');
  }
}

// Ex√©cuter si appel√© directement
if (require.main === module) {
  setupDatabase();
}

module.exports = { setupDatabase }; 